image: joinal/google-cloud-sdk-movie-app:latest

services:
  - name: docker:20-dind
    alias: docker
    command: ["--tls=false"]
#    variables:
#      HEALTHCHECK_TCP_PORT: "2375"

stages:
  - build
  - test
  - package
  - deploy

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2
#  FF_NETWORK_PER_BUILD: "true"


build-job:
  image: joinal/google-cloud-sdk-movie-app:latest
  stage: build
  script:
    - echo "Hello, $GITLAB_USER_LOGIN!"
    - export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
    - cd user-authentication
    - mvn clean
    - mvn compile
    - cd ..
  rules:
    - changes:
        - "user-authentication/**/*"

test-job:
  stage: test
  script:
    - echo "This job tests something"
    - mvn test
  rules:
    - changes:
        - "user-authentication/**/*"

package-job:
  stage: package
  script:
    - cd user-authentication
    - mvn package
  artifacts:
    paths:
      - "user-authentication/target/"
  rules:
    - changes:
        - "user-authentication/**/*"


deploy-job:
  stage: deploy
  script:
    - cd user-authentication
    - docker build -t us-west1-docker.pkg.dev/aerial-venture-386206/movie-app-user-authentication/movie-app-user-authentication .
    - gcloud auth configure-docker us-west1-docker.pkg.dev
    - docker push us-west1-docker.pkg.dev/aerial-venture-386206/movie-app-user-authentication/movie-app-user-authentication
    - sleep 5
    - gcloud container images list-tags us-west1-docker.pkg.dev/aerial-venture-386206/movie-app-user-authentication/movie-app-user-authentication --filter='-tags:*' --format='get(digest)' --limit=unlimited | xargs -I {arg} gcloud container images delete "us-west1-docker.pkg.dev/aerial-venture-386206/movie-app-user-authentication/movie-app-user-authentication@{arg}" --quiet
    - kubectl rollout restart deploy movie-app-user-authentication
    - cd ..
  rules:
    - changes:
        - "user-authentication/**/*"

