image: joinal/google-cloud-sdk-movie-app:latest

stages:
  - build
  - test
  - deploy

#  [[runners]]
#  url = "https://gitlab.com/"
#  token = RUNNER_TOKEN
#  executor = "docker"
#  [runners.docker]
#  tls_verify = false
#  image = "docker:20.10.16"
#  privileged = false
#  disable_cache = false
#  volumes = ["/var/run/docker.sock:/var/run/docker.sock", "/cache"]
#  [runners.cache]
#  Insecure = false


build-job:
  stage: build
  script:
#    - gitlab-runner register -n \
#      --url https://gitlab.com/ \
#      --registration-token REGISTRATION_TOKEN \
#      --executor docker \
#      --description "My Docker Runner" \
#      --docker-image "docker:20.10.16" \
#      --docker-volumes /var/run/docker.sock:/var/run/docker.sock
    - echo "Hello, $GITLAB_USER_LOGIN!"
    - export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
    - cd user-authentication
    - mvn clean
    - mvn package
    - cd..
  artifacts:
    paths:
      - "user-authentication/target/"

test-job:
  stage: test
  script:
    - echo "This job tests something"

package-job:
  stage: deploy
  image: quay.io/buildah/stable
  variables:
    STORAGE_DRIVER: vfs
    BUILDAH_FORMAT: docker
    BUILDAH_ISOLATION: chroot
    FQ_IMAGE_NAME: "$CI_REGISTRY_IMAGE/test"
  script:
    - cd user-authentication
    - buildah images
    - buildah build -t us-west1-docker.pkg.dev/aerial-venture-386206/movie-app-user-authentication/movie-app-user-authentication
    - gcloud auth configure-docker us-west1-docker.pkg.dev
    - buildah images
    - buildah push us-west1-docker.pkg.dev/aerial-venture-386206/movie-app-user-authentication/movie-app-user-authentication
    - sleep 5
    - gcloud container images list-tags us-west1-docker.pkg.dev/aerial-venture-386206/movie-app-user-authentication/movie-app-user-authentication \
      --filter='-tags:*' --format='get(digest)' --limit=unlimited |\
      xargs -I {arg} gcloud container images delete \
      "us-west1-docker.pkg.dev/aerial-venture-386206/movie-app-user-authentication/movie-app-user-authentication@{arg}" --quiet
    - kubectl rollout restart deploy movie-app-user-authentication
    - cd ..

