image: docker

services:
  - docker:dind

stages:
  - build
  - test
  - package
  - deploy

variables:
  DOCKER_HOST: tcp://docker:2376
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2

build-job:
  image: joinal/google-cloud-sdk-movie-app:latest
  stage: build
  script:
#    - gitlab-runner register -n \
#      --url https://gitlab.com/ \
#      --registration-token REGISTRATION_TOKEN \
#      --executor docker \
#      --description "My Docker Runner" \
#      --docker-image "docker:20.10.16" \
#      --docker-volumes /var/run/docker.sock:/var/run/docker.sock
    - echo "Hello, $GITLAB_USER_LOGIN!"
    - export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
    - cd user-authentication
    - mvn clean
    - mvn package
    - cd ..
  artifacts:
    paths:
      - "user-authentication/target/"

test-job:
  stage: test
  script:
    - echo "This job tests something"

package-job:
  stage: package
  script:
    - cd user-authentication
    - docker build -t us-west1-docker.pkg.dev/aerial-venture-386206/movie-app-user-authentication/movie-app-user-authentication .
    - cd ..

deploy-job:
  image: joinal/google-cloud-sdk-movie-app:latest
  stage: deploy
  script:
    - gcloud auth configure-docker us-west1-docker.pkg.dev
    - docker push us-west1-docker.pkg.dev/aerial-venture-386206/movie-app-user-authentication/movie-app-user-authentication
    - sleep 5
    - gcloud container images list-tags us-west1-docker.pkg.dev/aerial-venture-386206/movie-app-user-authentication/movie-app-user-authentication \
      --filter='-tags:*' --format='get(digest)' --limit=unlimited |\
      xargs -I {arg} gcloud container images delete \
      "us-west1-docker.pkg.dev/aerial-venture-386206/movie-app-user-authentication/movie-app-user-authentication@{arg}" --quiet
    - kubectl rollout restart deploy movie-app-user-authentication
